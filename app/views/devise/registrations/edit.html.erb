<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <h2 class="page-title">Profile Settings</h2>
        <div class="text-muted mt-1">Manage your account information</div>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">
    <div class="row row-deck row-cards">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs">
              <li class="nav-item">
                <a href="#tabs-profile" class="nav-link <%= @tab == 'password' || @tab == 'danger' ? '' : 'active' %>" data-bs-toggle="tab">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" />
                    <path d="M12 10m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" />
                    <path d="M6.168 18.849a4 4 0 0 1 3.832 -2.849h4a4 4 0 0 1 3.834 2.855" />
                  </svg>
                  Profile
                </a>
              </li>
              <li class="nav-item">
                <a href="#tabs-password" class="nav-link <%= @tab == 'password' ? 'active' : '' %>" data-bs-toggle="tab">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                    <path d="M5 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-6z" />
                    <path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0" />
                    <path d="M8 11v-4a4 4 0 1 1 8 0v4" />
                  </svg>
                  Password
                </a>
              </li>
              <li class="nav-item">
                <a href="#tabs-danger" class="nav-link <%= @tab == 'danger' ? 'active' : '' %>" data-bs-toggle="tab">
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-alert-triangle" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M10.24 3.957l-8.422 14.06a1.989 1.989 0 0 0 1.7 2.983h16.845a1.989 1.989 0 0 0 1.7 -2.983l-8.423 -14.06a1.989 1.989 0 0 0 -3.4 0z"></path>
                    <path d="M12 9v4"></path>
                    <path d="M12 17h.01"></path>
                  </svg>
                  Danger Zone
                </a>
              </li>
            </ul>
          </div>

          <div class="card-body">
            <div class="tab-content">
                <div class="tab-pane <%= @tab == 'password' || @tab == 'danger' ? '' : 'active show' %>" id="tabs-profile">
                  <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put, multipart: true }) do |f| %>
                    <%= render "devise/shared/error_messages", resource: resource %>
                    
                    <%= render 'users/avatar_management', user: current_user, show_remove_button: true %>
                    
                    <div class="btn-list mb-3">
                      <label class="btn btn-sm btn-outline-primary" id="avatar-upload-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-photo" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                          <path d="M15 8h.01"></path>
                          <path d="M3 6a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v12a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3v-12z"></path>
                          <path d="M3 16l5 -5c.928 -.893 2.072 -.893 3 0l5 5"></path>
                          <path d="M14 14l1 -1c.928 -.893 2.072 -.893 3 0l3 3"></path>
                        </svg>
                        <span id="avatar-label-text">Upload avatar</span>
                        <%= f.file_field :avatar, style: "display: none;", accept: "image/png,image/jpeg,image/jpg,image/gif", id: "avatar-upload-input" %>
                      </label>
                      <div id="avatar-filename" class="d-none mt-2 text-muted small"></div>
                    </div>

                    <h3 class="card-title mt-4">Personal Information</h3>
                    
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label class="form-label"><%= f.label :first_name %></label>
                        <div class="input-group input-group-flat">
                          <span class="input-group-text">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                              <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0"></path>
                              <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
                            </svg>
                          </span>
                          <%= f.text_field :first_name, class: "form-control", placeholder: "First name" %>
                        </div>
                      </div>
                      
                      <div class="col-md-6 mb-3">
                        <label class="form-label"><%= f.label :last_name %></label>
                        <div class="input-group input-group-flat">
                          <span class="input-group-text">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                              <path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0"></path>
                              <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
                            </svg>
                          </span>
                          <%= f.text_field :last_name, class: "form-control", placeholder: "Last name" %>
                        </div>
                      </div>
                    </div>
                    
                    <div class="mb-3">
                      <label class="form-label"><%= f.label :birthdate %></label>
                      <div class="input-group input-group-flat">
                        <span class="input-group-text">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                            <path d="M4 5m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"></path>
                            <path d="M16 3l0 4"></path>
                            <path d="M8 3l0 4"></path>
                            <path d="M4 11l16 0"></path>
                            <path d="M11 15l1 0"></path>
                            <path d="M12 15l0 3"></path>
                          </svg>
                        </span>
                        <%= f.date_field :birthdate, class: "form-control", placeholder: "YYYY-MM-DD" %>
                      </div>
                      <div class="form-hint">
                        Format: YYYY-MM-DD (e.g., 1990-01-01)
                      </div>
                    </div>
                    
                    <h3 class="card-title mt-4">Account Information</h3>
                    
                    <div class="mb-3">
                      <label class="form-label"><%= f.label :email %></label>
                      <div class="input-group input-group-flat">
                        <span class="input-group-text">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z" />
                            <path d="M3 7l9 6l9 -6" />
                          </svg>
                        </span>
                        <%= f.email_field :email, autofocus: true, autocomplete: "email", class: "form-control" %>
                      </div>
                      <% if devise_mapping.confirmable? && resource.pending_reconfirmation? %>
                        <div class="form-hint text-warning">
                          Currently waiting confirmation for: <%= resource.unconfirmed_email %>
                        </div>
                      <% end %>
                    </div>
                    
                    <div class="form-footer mt-4">
                      <%= f.submit "Save Changes", class: "btn btn-primary" %>
                      <%= link_to "Cancel", :back, class: "btn btn-link" %>
                    </div>
                  <% end %>
                </div>
                
                <div class="tab-pane <%= @tab == 'password' ? 'active show' : '' %>" id="tabs-password">
                  <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put }) do |f| %>
                    <%= render "devise/shared/error_messages", resource: resource %>
                    
                    <h3 class="card-title">Password Settings</h3>
                    <p class="text-muted mb-4">Update your password securely. Your password should be at least <%= @minimum_password_length %> characters long and include a mix of letters, numbers, and symbols for better security.</p>
                    
                    <div class="mb-3">
                      <label class="form-label">
                        <%= f.label :password %>
                        <span class="form-label-description">
                          <% if @minimum_password_length %>
                            <%= @minimum_password_length %> characters minimum
                          <% end %>
                        </span>
                      </label>
                      <div class="input-group input-group-flat">
                        <span class="input-group-text">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M5 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-6z" />
                            <path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0" />
                            <path d="M8 11v-4a4 4 0 1 1 8 0v4" />
                          </svg>
                        </span>
                        <%= f.password_field :password, autocomplete: "new-password", class: "form-control", placeholder: "New password" %>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label class="form-label"><%= f.label :password_confirmation %></label>
                      <div class="input-group input-group-flat">
                        <span class="input-group-text">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M5 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-6z" />
                            <path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0" />
                            <path d="M8 11v-4a4 4 0 1 1 8 0v4" />
                          </svg>
                        </span>
                        <%= f.password_field :password_confirmation, autocomplete: "new-password", class: "form-control", placeholder: "Confirm your new password" %>
                      </div>
                    </div>

                    <div class="mb-4">
                      <label class="form-label"><%= f.label :current_password %> <span class="form-label-description">(required to confirm changes)</span></label>
                      <div class="input-group input-group-flat">
                        <span class="input-group-text">
                          <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                            <path d="M16.555 3.843l3.602 3.602a2.877 2.877 0 0 1 0 4.069l-2.643 2.643a2.877 2.877 0 0 1 -4.069 0l-.301 -.301l-6.558 6.558a2 2 0 0 1 -1.239 .578l-.175 .008h-1.172a1 1 0 0 1 -.993 -.883l-.007 -.117v-1.172a2 2 0 0 1 .467 -1.284l.119 -.13l.414 -.414h2v-2h2v-2l2.144 -2.144l-.301 -.301a2.877 2.877 0 0 1 0 -4.069l2.643 -2.643a2.877 2.877 0 0 1 4.069 0z"/>
                            <path d="M15 9h.01"/>
                          </svg>
                        </span>
                        <%= f.password_field :current_password, autocomplete: "current-password", class: "form-control" %>
                      </div>
                    </div>
                    
                    <div class="form-footer mt-4">
                      <%= f.submit "Update Password", class: "btn btn-primary" %>
                      <%= link_to "Cancel", :back, class: "btn btn-link" %>
                    </div>
                  <% end %>
                </div>
                
                <div class="tab-pane <%= @tab == 'danger' ? 'active show' : '' %>" id="tabs-danger">
                  <div class="card card-danger">
                    <div class="card-status-top bg-danger"></div>
                    <div class="card-body">
                      <h3 class="card-title text-danger">Delete Account</h3>
                      <p class="text-muted">Once you delete your account, there is no going back. Please be certain before proceeding with this action.</p>
                      
                      <div class="alert alert-warning" role="alert">
                        <div class="d-flex">
                          <div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                              <path d="M12 9v2m0 4v.01"></path>
                              <path d="M5 19h14a2 2 0 0 0 1.84 -2.75l-7.1 -12.25a2 2 0 0 0 -3.5 0l-7.1 12.25a2 2 0 0 0 1.75 2.75"></path>
                            </svg>
                          </div>
                          <div>
                            <h4 class="alert-title">Warning!</h4>
                            <div class="text-muted">Account deletion cannot be undone. All your data and access will be permanently removed.</div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="mt-3">
                        <%= button_to registration_path(resource_name), 
                            method: :delete, 
                            class: "btn btn-danger w-100",
                            form: { data: { turbo_confirm: "Are you sure you want to delete your account? This action cannot be undone." } } do %>
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-1" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                              <path d="M4 7l16 0" />
                              <path d="M10 11l0 6" />
                              <path d="M14 11l0 6" />
                              <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" />
                              <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" />
                            </svg>
                            Delete my account
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Avatar upload handling
    const avatarInput = document.getElementById('avatar-upload-input');
    const avatarLabelText = document.getElementById('avatar-label-text');
    const avatarFilename = document.getElementById('avatar-filename');
    
    if (avatarInput) {
      avatarInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          const file = this.files[0];
          const fileSize = (file.size / 1024 / 1024).toFixed(2); // size in MB
          
          // Show filename and size
          avatarFilename.textContent = `Selected: ${file.name} (${fileSize} MB)`;
          avatarFilename.classList.remove('d-none');
          
          // Update button text
          avatarLabelText.textContent = 'Change avatar';
          
          // Preview image if needed
          const reader = new FileReader();
          reader.onload = function(e) {
            // You could add image preview functionality here if desired
          }
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Tab handling - preserve active tab after form submission errors
    const hash = window.location.hash;
    if (hash && hash.startsWith('#tabs-')) {
      const tabId = hash.substring(1);
      const tabElement = document.getElementById(tabId);
      
      if (tabElement) {
        const tabLink = document.querySelector(`[data-bs-toggle="tab"][href="#${tabId}"]`);
        if (tabLink) {
          const tab = new bootstrap.Tab(tabLink);
          tab.show();
        }
      }
    }
    
    // Add hash to URL when tab is changed
    const tabEls = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabEls.forEach(tabEl => {
      tabEl.addEventListener('shown.bs.tab', function (event) {
        const id = event.target.getAttribute('href').substring(1);
        window.history.replaceState(null, null, `#${id}`);
      });
    });
  });
</script>
